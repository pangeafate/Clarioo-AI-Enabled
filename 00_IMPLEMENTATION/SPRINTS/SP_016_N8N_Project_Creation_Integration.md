# SP_016: n8n Project Creation Integration

## Sprint Overview

**Sprint Name**: n8n AI Project Creation Integration
**Duration**: 1-2 days (8-12 hours estimated)
**Status**: ✅ Complete (Completed: November 23, 2024)
**Type**: Backend Integration - AI Workflow Migration
**Priority**: High

---

## Sprint Goal

Replace the mock AI service for project and criteria creation with a real n8n workflow that uses GPT-4o-mini to generate intelligent project names, descriptions, categories, and evaluation criteria based on user input.

---

## Background

### Current State
- Project creation uses mock services with pre-defined JSON data
- Criteria generation returns static mock criteria
- No real AI processing

### Target State
- Project + criteria generated by n8n workflow with GPT-4o-mini
- Real-time AI processing based on user's company context and solution requirements
- Data stored in localStorage (ephemeral - clears with browser)

### n8n Workflow Details
- **Endpoint**: `POST https://n8n.lakestrom.com/webhook/clarioo-project-creation`
- **AI Model**: GPT-4o-mini (temperature: 0.3, max tokens: 6000)
- **Timeout**: 45 seconds
- **Output**: Project metadata + 10-15 criteria with importance/type

---

## Sprint Objectives

1. Create n8n API service with proper typing and error handling
2. Implement user_id (localStorage) and session_id (sessionStorage) generation
3. Create useProjectCreation hook for React integration
4. Update AnimatedInputs to trigger n8n project creation
5. Update workflow to accept and use n8n-generated criteria
6. Map n8n response fields to app's existing data structures
7. Handle loading states, timeouts, and errors gracefully
8. Test integration locally with various input scenarios

---

## Technical Specification

### 1. Type Definitions (`src/types/n8n.types.ts`)

```typescript
// Request to n8n
export interface N8nProjectCreationRequest {
  user_id: string;
  session_id: string;
  company_context: string;
  solution_requirements: string;
  timestamp: string; // ISO 8601
}

// Response from n8n
export interface N8nProjectCreationResponse {
  success: boolean;
  project?: {
    name: string;
    description: string;
    category: string;
  };
  criteria?: N8nCriterion[];
  error?: {
    code: string;
    message: string;
  };
}

export interface N8nCriterion {
  id: string;
  name: string;
  description: string; // Maps to our "explanation" field
  importance: 'low' | 'medium' | 'high';
  type: 'feature' | 'technical' | 'business' | 'compliance';
  isArchived: boolean;
}
```

### 2. n8n Service (`src/services/n8nService.ts`)

```typescript
const N8N_WEBHOOK_URL = 'https://n8n.lakestrom.com/webhook/clarioo-project-creation';
const TIMEOUT_MS = 45000;

// User ID - persistent across sessions
export const getUserId = (): string => {
  let userId = localStorage.getItem('clarioo_user_id');
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem('clarioo_user_id', userId);
  }
  return userId;
};

// Session ID - per browser session
export const getSessionId = (): string => {
  let sessionId = sessionStorage.getItem('clarioo_session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    sessionStorage.setItem('clarioo_session_id', sessionId);
  }
  return sessionId;
};

// Main API call
export const createProjectWithAI = async (
  companyContext: string,
  solutionRequirements: string
): Promise<N8nProjectCreationResponse> => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

  try {
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: getUserId(),
        session_id: getSessionId(),
        company_context: companyContext,
        solution_requirements: solutionRequirements,
        timestamp: new Date().toISOString(),
      }),
      signal: controller.signal,
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(`HTTP error: ${response.status}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error?.message || 'AI processing failed');
    }

    return data;
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Request timeout - AI processing took too long (45s limit)');
    }
    throw error;
  }
};
```

### 3. Data Transformation

Map n8n response to app's existing data structures:

```typescript
// Transform n8n criterion to app criterion format
export const transformN8nCriterion = (n8nCriterion: N8nCriterion): Criterion => ({
  id: n8nCriterion.id,
  name: n8nCriterion.name,
  explanation: n8nCriterion.description, // KEY MAPPING
  importance: n8nCriterion.importance,
  type: n8nCriterion.type,
  isArchived: n8nCriterion.isArchived,
});

// Transform n8n response to app project format
export const transformN8nProject = (
  n8nResponse: N8nProjectCreationResponse,
  companyContext: string,
  solutionRequirements: string
): Project => ({
  id: crypto.randomUUID(),
  name: n8nResponse.project!.name,
  description: n8nResponse.project!.description,
  category: n8nResponse.project!.category,
  status: 'active',
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
  techRequest: {
    companyContext,
    solutionRequirements,
  },
});
```

### 4. useProjectCreation Hook (`src/hooks/useProjectCreation.ts`)

```typescript
export const useProjectCreation = () => {
  const [isCreating, setIsCreating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createProject = async (
    companyContext: string,
    solutionRequirements: string
  ): Promise<{ project: Project; criteria: Criterion[] } | null> => {
    setIsCreating(true);
    setError(null);

    try {
      const response = await createProjectWithAI(companyContext, solutionRequirements);

      const project = transformN8nProject(response, companyContext, solutionRequirements);
      const criteria = response.criteria!.map(transformN8nCriterion);

      // Store in localStorage
      saveProjectToStorage(project);
      saveCriteriaToStorage(project.id, criteria);

      return { project, criteria };
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Failed to create project';
      setError(message);
      return null;
    } finally {
      setIsCreating(false);
    }
  };

  return { createProject, isCreating, error };
};
```

---

## Implementation Phases

### Phase 1: Service Layer (2-3 hours)

**Tasks**:
1. Create `src/types/n8n.types.ts` with all type definitions
2. Create `src/services/n8nService.ts` with:
   - getUserId() / getSessionId() utilities
   - createProjectWithAI() API function
   - transformN8nCriterion() / transformN8nProject() mappers
3. Export from types/index.ts

**Exit Criteria**:
- Types compile without errors
- Service functions are properly typed
- Transformation functions handle all fields

### Phase 2: Hook Integration (2-3 hours)

**Tasks**:
1. Create `src/hooks/useProjectCreation.ts`
2. Implement localStorage persistence for projects
3. Implement localStorage persistence for criteria
4. Add loading and error states
5. Test hook in isolation

**Exit Criteria**:
- Hook returns { createProject, isCreating, error }
- Projects saved to localStorage correctly
- Criteria saved with project association
- Error handling works for all error types

### Phase 3: UI Integration (3-4 hours)

**Tasks**:
1. Update `AnimatedInputs.tsx`:
   - Add "Create with AI" button/trigger
   - Show loading spinner during API call
   - Display progress feedback
   - Handle success → create project → navigate to workflow
   - Handle errors with toast notifications

2. Update `LandingPage.tsx`:
   - Integrate useProjectCreation hook
   - Handle project creation flow
   - Navigate to workflow with new project

3. Update `VendorDiscovery.tsx`:
   - Accept pre-generated criteria from n8n
   - Skip criteria generation if already provided
   - Load criteria from localStorage on mount

**Exit Criteria**:
- User can enter inputs and trigger AI creation
- Loading state shows during 45s max wait
- Success creates project and navigates to workflow
- Errors show user-friendly toast messages
- Workflow displays n8n-generated criteria

### Phase 4: Testing & Polish (2-3 hours)

**Tasks**:
1. Test with various input scenarios:
   - Short inputs (edge case)
   - Long detailed inputs
   - Different industries (healthcare, finance, tech)
2. Test error scenarios:
   - Network failure
   - Timeout (45s)
   - Invalid response
3. Test localStorage persistence:
   - Refresh page
   - Close/reopen browser
   - Clear storage
4. Visual polish:
   - Loading animations
   - Success feedback
   - Error messages

**Exit Criteria**:
- All happy path scenarios work
- All error scenarios handled gracefully
- Data persists correctly in localStorage
- UI feedback is clear and helpful

---

## Files to Create

| File | Description |
|------|-------------|
| `src/types/n8n.types.ts` | Type definitions for n8n API |
| `src/services/n8nService.ts` | n8n API client and utilities |
| `src/hooks/useProjectCreation.ts` | React hook for project creation |

## Files to Modify

| File | Changes |
|------|---------|
| `src/types/index.ts` | Export n8n types |
| `src/components/landing/AnimatedInputs.tsx` | Add AI creation trigger |
| `src/components/landing/LandingPage.tsx` | Integrate project creation flow |
| `src/components/VendorDiscovery.tsx` | Accept pre-generated criteria |
| `src/hooks/useCriteriaGeneration.ts` | Support n8n criteria format |

---

## Data Flow

```
User Input (AnimatedInputs)
    │
    ▼
useProjectCreation hook
    │
    ▼
n8nService.createProjectWithAI()
    │
    ▼
POST to n8n webhook ────────────────┐
    │                               │
    ▼                               ▼
n8n Workflow              GPT-4o-mini AI
    │                               │
    └───────────────────────────────┘
                    │
                    ▼
          JSON Response
    (project + 10-15 criteria)
                    │
                    ▼
    Transform to app format
                    │
                    ▼
    Save to localStorage
    - project data
    - criteria array
                    │
                    ▼
    Navigate to VendorDiscovery
    with project.id
                    │
                    ▼
    VendorDiscovery loads
    criteria from localStorage
```

---

## Storage Schema

### localStorage Keys

```typescript
// User ID (persistent)
'clarioo_user_id': string (UUID v4)

// Projects list
'clarioo_projects': Project[]

// Criteria per project
'criteria_${projectId}': Criterion[]

// Workflow state per project
'workflow_${projectId}': WorkflowState
```

### sessionStorage Keys

```typescript
// Session ID (per tab/session)
'clarioo_session_id': string (UUID v4)
```

---

## Error Handling

| Error Type | User Message | Action |
|------------|--------------|--------|
| Network failure | "Unable to connect to AI service. Please check your connection." | Toast, allow retry |
| Timeout (45s) | "AI processing took too long. Please try again." | Toast, allow retry |
| Invalid input | "Please provide more details (at least 10 characters)." | Form validation |
| AI processing error | "AI couldn't generate criteria. Please try again with different input." | Toast, allow retry |
| Invalid response | "Received invalid response from AI service." | Toast, log error |

---

## Testing Checklist

### Functional Tests
- [ ] Create project with minimal input (10 chars each)
- [ ] Create project with detailed input
- [ ] Verify 10-15 criteria generated
- [ ] Verify criteria distribution (feature/technical/business/compliance)
- [ ] Verify importance levels assigned appropriately
- [ ] Verify project name/description/category generated
- [ ] Verify data persists in localStorage
- [ ] Verify workflow loads with n8n criteria

### Error Tests
- [ ] Test with empty inputs (validation)
- [ ] Test with network disconnected
- [ ] Test timeout behavior (may need to simulate)
- [ ] Test invalid response handling

### UI Tests
- [ ] Loading spinner appears during API call
- [ ] Progress indicator shows status
- [ ] Success toast appears
- [ ] Error toast appears with helpful message
- [ ] Retry button works after error

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| n8n server downtime | Low | High | Add error handling, show helpful message |
| Slow AI response | Medium | Medium | 45s timeout, loading indicator |
| Inconsistent AI output | Low | Medium | Validation in "Format Success Response" node |
| CORS issues | Low | Medium | n8n configured for cross-origin |

---

## Success Metrics

- [ ] Project creation works end-to-end
- [ ] AI generates relevant criteria based on input
- [ ] Average response time < 15 seconds
- [ ] Error rate < 5%
- [ ] User can complete full workflow with n8n data
- [ ] Build passes with 0 errors

---

## Sprint Timeline

| Phase | Duration | Deliverables |
|-------|----------|--------------|
| Phase 1: Service Layer | 2-3 hours | Types, API service, transformers |
| Phase 2: Hook Integration | 2-3 hours | useProjectCreation hook, storage |
| Phase 3: UI Integration | 3-4 hours | AnimatedInputs, LandingPage, VendorDiscovery |
| Phase 4: Testing | 2-3 hours | All scenarios tested, polish |
| **Total** | **9-13 hours** | Full n8n integration |

---

## Definition of Done

- [ ] n8n service created with proper error handling
- [ ] Types defined and exported
- [ ] useProjectCreation hook functional
- [ ] AnimatedInputs triggers AI creation
- [ ] Loading states displayed during API call
- [ ] Success navigates to workflow with criteria
- [ ] Errors handled with user-friendly messages
- [ ] Data persists in localStorage
- [ ] Build passes with 0 TypeScript errors
- [ ] Manual testing completed for all scenarios
- [ ] Documentation updated (PROGRESS.md, PROJECT_ROADMAP.md)

---

## Next Steps After SP_016

1. **SP_017**: n8n Vendor Selection Integration
   - Replace mock vendor selection with n8n AI
   - Generate vendor recommendations based on criteria

2. **SP_018**: n8n Vendor Comparison Integration
   - Replace mock comparison with n8n AI
   - Generate match scores and executive summary

---

**Sprint Plan Created**: November 23, 2024
**Author**: Claude Code
**Version**: 1.0
