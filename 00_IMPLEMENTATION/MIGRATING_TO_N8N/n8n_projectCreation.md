# n8n Project Creation Integration

## Overview

This document describes the data contract between the Clarioo frontend and n8n workflow for AI-powered project creation and criteria generation.

**Workflow URL**: `https://n8n.lakestrom.com/workflow/1Y3ccWq3Llp4fb1z`
**Trigger Type**: Webhook
**Authentication**: None (for now)
**Timeout**: 45 seconds

---

## Request: Frontend → n8n

### Endpoint

```
POST https://n8n.lakestrom.com/webhook/clarioo-project-creation
```

### Headers

```json
{
  "Content-Type": "application/json"
}
```

### Request Body

```json
{
  "user_id": "string | null",
  "session_id": "string",
  "company_context": "string",
  "solution_requirements": "string",
  "timestamp": "string (ISO 8601)"
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `user_id` | string \| null | No | Persistent user identifier stored in localStorage. Generated as UUID v4 on first visit. `null` if not available. |
| `session_id` | string | Yes | Temporary session identifier. Generated as UUID v4 per browser session (sessionStorage). |
| `company_context` | string | Yes | User's company background and context. From "Tell me more about your company" input field. Min 10 characters. |
| `solution_requirements` | string | Yes | User's requirements and needs. From "Tell me what solution you're looking for" input field. Min 10 characters. |
| `timestamp` | string | Yes | Request timestamp in ISO 8601 format (e.g., "2025-11-23T12:00:00.000Z"). |

### Example Request

```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "session_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "company_context": "We are a mid-size SaaS company with 50 employees in the healthcare sector. We currently use spreadsheets for customer tracking and need better organization.",
  "solution_requirements": "Looking for a CRM system with email integration, mobile app support, HIPAA compliance, and ability to track patient communications. Currently evaluating Salesforce Health Cloud and HubSpot.",
  "timestamp": "2025-11-23T12:00:00.000Z"
}
```

---

## Response: n8n → Frontend

### Success Response (200 OK)

```json
{
  "success": true,
  "project": {
    "name": "string",
    "description": "string",
    "category": "string"
  },
  "criteria": [
    {
      "id": "string",
      "name": "string",
      "description": "string",
      "importance": "low" | "medium" | "high",
      "type": "feature" | "technical" | "business" | "compliance",
      "isArchived": false
    }
  ]
}
```

### Project Object

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | AI-generated project name based on solution requirements. Max 100 characters. |
| `description` | string | AI-refined description combining company context and requirements. |
| `category` | string | AI-determined category based on solution type (e.g., "CRM Software", "ERP System", "HR Software"). Default to "General" if unable to determine. |

### Criteria Object

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique identifier (UUID v4 format). Generated by n8n. |
| `name` | string | Criterion name/title. Concise and actionable. |
| `description` | string | Detailed description of what this criterion evaluates. |
| `importance` | enum | AI-determined importance: `"low"`, `"medium"`, or `"high"`. Based on user requirements and domain knowledge. |
| `type` | enum | Category type: `"feature"`, `"technical"`, `"business"`, or `"compliance"`. |
| `isArchived` | boolean | Always `false` for newly generated criteria. |

### Criteria Distribution Guidelines

The AI should generate criteria with the following distribution:

- **Feature**: Majority of criteria (~40-50%)
- **Technical**: ~15-20%
- **Business**: ~15-20%
- **Compliance**: ~15-20%

Total criteria: 10-15 items (flexible based on complexity of requirements)

### Importance Allocation

The AI should determine importance based on:

1. **High**: Critical requirements explicitly mentioned by user, industry-standard must-haves, compliance requirements for regulated industries
2. **Medium**: Important features mentioned or implied, common best practices
3. **Low**: Nice-to-have features, advanced capabilities, optimization features

### Example Success Response

```json
{
  "success": true,
  "project": {
    "name": "Healthcare CRM Evaluation",
    "description": "Evaluating CRM solutions for a 50-employee healthcare SaaS company. Key requirements include email integration, mobile support, HIPAA compliance, and patient communication tracking. Currently comparing Salesforce Health Cloud and HubSpot.",
    "category": "CRM Software"
  },
  "criteria": [
    {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "HIPAA Compliance",
      "description": "System must be fully HIPAA compliant with BAA (Business Associate Agreement) support, encrypted data storage, and audit logging for all patient data access.",
      "importance": "high",
      "type": "compliance",
      "isArchived": false
    },
    {
      "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
      "name": "Email Integration",
      "description": "Seamless integration with email providers (Gmail, Outlook) for automatic email logging, templates, and tracking of customer communications.",
      "importance": "high",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
      "name": "Mobile Application",
      "description": "Native mobile apps for iOS and Android with offline capability, push notifications, and full CRM functionality on mobile devices.",
      "importance": "high",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "d4e5f6a7-b8c9-0123-defa-234567890123",
      "name": "Patient Communication Tracking",
      "description": "Ability to track and log all patient communications including calls, emails, and messages with timeline view and searchable history.",
      "importance": "high",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "e5f6a7b8-c9d0-1234-efab-345678901234",
      "name": "Data Encryption",
      "description": "End-to-end encryption for data at rest and in transit, meeting healthcare industry security standards.",
      "importance": "high",
      "type": "technical",
      "isArchived": false
    },
    {
      "id": "f6a7b8c9-d0e1-2345-fabc-456789012345",
      "name": "Contact Management",
      "description": "Comprehensive contact database with custom fields, segmentation, tagging, and duplicate detection.",
      "importance": "medium",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "a7b8c9d0-e1f2-3456-abcd-567890123456",
      "name": "Reporting & Analytics",
      "description": "Built-in reporting dashboard with customizable reports, KPI tracking, and data visualization.",
      "importance": "medium",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "b8c9d0e1-f2a3-4567-bcde-678901234567",
      "name": "API Access",
      "description": "RESTful API for custom integrations with existing healthcare systems and third-party applications.",
      "importance": "medium",
      "type": "technical",
      "isArchived": false
    },
    {
      "id": "c9d0e1f2-a3b4-5678-cdef-789012345678",
      "name": "Pricing & Scalability",
      "description": "Transparent pricing model that scales with company growth. Consider per-user pricing and enterprise tiers.",
      "importance": "medium",
      "type": "business",
      "isArchived": false
    },
    {
      "id": "d0e1f2a3-b4c5-6789-defa-890123456789",
      "name": "Vendor Support & SLA",
      "description": "24/7 support availability, dedicated account manager, and guaranteed uptime SLA (99.9%+).",
      "importance": "medium",
      "type": "business",
      "isArchived": false
    },
    {
      "id": "e1f2a3b4-c5d6-7890-efab-901234567890",
      "name": "Data Migration Support",
      "description": "Tools and support for migrating existing customer data from spreadsheets to the new CRM system.",
      "importance": "medium",
      "type": "technical",
      "isArchived": false
    },
    {
      "id": "f2a3b4c5-d6e7-8901-fabc-012345678901",
      "name": "Audit Trail",
      "description": "Complete audit logging of all system activities for compliance reporting and security monitoring.",
      "importance": "medium",
      "type": "compliance",
      "isArchived": false
    },
    {
      "id": "a3b4c5d6-e7f8-9012-abcd-123456789012",
      "name": "Workflow Automation",
      "description": "Automated workflows for lead nurturing, follow-up reminders, and routine task automation.",
      "importance": "low",
      "type": "feature",
      "isArchived": false
    },
    {
      "id": "b4c5d6e7-f8a9-0123-bcde-234567890123",
      "name": "Third-party Integrations",
      "description": "Pre-built integrations with popular tools like Slack, Zoom, and calendar applications.",
      "importance": "low",
      "type": "feature",
      "isArchived": false
    }
  ]
}
```

---

## Error Response

### Error Response Format

```json
{
  "success": false,
  "error": {
    "code": "string",
    "message": "string"
  }
}
```

### Error Codes

| Code | Description |
|------|-------------|
| `INVALID_INPUT` | Missing or invalid input fields |
| `AI_PROCESSING_ERROR` | AI model failed to generate response |
| `INTERNAL_ERROR` | Unexpected server error |

### Example Error Response

```json
{
  "success": false,
  "error": {
    "code": "INVALID_INPUT",
    "message": "company_context must be at least 10 characters"
  }
}
```

---

## Frontend Implementation Notes

### User ID Generation

```typescript
// Generate or retrieve persistent user ID
const getUserId = (): string => {
  let userId = localStorage.getItem('clarioo_user_id');
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem('clarioo_user_id', userId);
  }
  return userId;
};
```

### Session ID Generation

```typescript
// Generate or retrieve session ID
const getSessionId = (): string => {
  let sessionId = sessionStorage.getItem('clarioo_session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    sessionStorage.setItem('clarioo_session_id', sessionId);
  }
  return sessionId;
};
```

### API Call Implementation

```typescript
const createProjectWithAI = async (
  companyContext: string,
  solutionRequirements: string
): Promise<ProjectCreationResponse> => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout

  try {
    const response = await fetch('https://n8n.lakestrom.com/webhook/project-creation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: getUserId(),
        session_id: getSessionId(),
        company_context: companyContext,
        solution_requirements: solutionRequirements,
        timestamp: new Date().toISOString(),
      }),
      signal: controller.signal,
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error?.message || 'AI processing failed');
    }

    return data;
  } catch (error) {
    if (error.name === 'AbortError') {
      throw new Error('Request timeout - AI processing took too long');
    }
    throw error;
  }
};
```

### Error Handling

```typescript
try {
  const result = await createProjectWithAI(companyInput, solutionInput);
  // Process result.project and result.criteria
} catch (error) {
  toast({
    title: "AI Trigger Error",
    description: error.message || "Failed to generate project with AI. Please try again.",
    variant: "destructive",
  });
}
```

---

## n8n Workflow Implementation Notes

### Webhook Configuration

1. Create Webhook node as trigger
2. Set HTTP Method to `POST`
3. Set Path to `/project-creation`
4. Response Mode: "When Last Node Finishes"

### AI Processing Steps

1. **Parse Input**: Extract company_context and solution_requirements
2. **Generate Project**: Use AI to create project name, description, and determine category
3. **Generate Criteria**: Use AI to create 10-15 criteria based on requirements
4. **Categorize Criteria**: Assign type (feature/technical/business/compliance) to each
5. **Assign Importance**: Determine importance (high/medium/low) based on context
6. **Generate IDs**: Create UUID v4 for each criterion
7. **Format Response**: Structure response according to contract

### Prompt Guidelines for AI

When generating criteria, the AI should consider:

1. Explicitly mentioned requirements get `high` importance
2. Industry-standard requirements for the determined category
3. Technical requirements implied by integrations mentioned
4. Compliance requirements based on industry (healthcare → HIPAA, finance → SOC2, etc.)
5. Business considerations (pricing, support, scalability)

---

## Testing

### Test Request

```bash
curl -X POST https://n8n.lakestrom.com/webhook/project-creation \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test-user-123",
    "session_id": "test-session-456",
    "company_context": "Small tech startup with 10 employees building a mobile app",
    "solution_requirements": "Need project management tool with Kanban boards and time tracking",
    "timestamp": "2025-11-23T12:00:00.000Z"
  }'
```

### Expected Response Structure

- `success`: true
- `project.name`: Something like "Project Management Tool Evaluation"
- `project.category`: "Project Management Software"
- `criteria`: 10-15 items with appropriate distribution

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-11-23 | Initial specification |
